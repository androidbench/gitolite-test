<p><head><style>
    body        { background: #fff; margin-left:  40px;   font-size:  0.9em;  font-family: sans-serif; max-width: 800px; }
    h1          { background: #ffb; margin-left: -30px;   border-bottom: 5px  solid #ccc; }
    h2, h3      { background: #ffb; margin-left: -30px;   border-top:    3px  solid #ddd; }
    h4, h5      { background: #ffb; margin-left: -20px; }
    code        { font-size:    1.1em;  background:  #ddf; }
    pre         { margin-left:  2em;    background:  #ddf; }
    pre code    { font-size:    1.1em;  background:  #ddf; }
</style></head></p>

<h1>password access to gitolite</h1>

<h2>(a.k.a: turning real users into gitolite users)</h2>

<p><a name="_problems"></a></p>

<h3>problems</h3>

<p><em>Problem 1</em>: Here's one type of problem some admins have:</p>

<ul>
<li>Some of your users already have a real (unix) userid on the <em>same server</em>
as the gitolite hosting user.</li>
<li>They don't all use ssh keys; some may still be using passwords and don't
want to change.</li>
<li>They want to use this existing userid to access the gitolite served repos.</li>
</ul>

<p>This document has a solution to this problem!</p>

<p><em>Problem 2</em>: And here's a somewhat different one:</p>

<ul>
<li>Some of your users are not willing to use ssh keys; they're only
comfortable with passwords.</li>
<li>But gitolite <em>requires</em> ssh key-based access; it can't work if you use a
password to get access (because then there is no way to distinguish one
user from another).</li>
</ul>

<p>Well, as the math folks say, "reduce it to a known problem".  Give them all
Unix userids on the same server as gitolite, with password access, so that
problem 2 reduces to problem 1 ;-)</p>

<p><font color="gray">If you created these Unix accounts <em>only</em> to solve this
pesky password problem, and do not wish them to actually have shell access or
be able to do anything else on the server, don't worry -- that's easy to
handle too.</font></p>

<p><a name="_solution"></a></p>

<h3>solution</h3>

<p>Briefly, the Unix userid is made to act like a "gitolite proxy".</p>

<p>Here's a more detailed explanation.</p>

<p>Normal gitolite flow, for a user called Alice, is like this:</p>

<pre><code>                            ssh key
    alice     ----------------------------------------&gt;    git
(workstation)              (REQUIRED)                    (server)
</code></pre>

<p>However, if Alice has her own real (unix) userid on the server, and the admin
sets things up according to this document, then Alice can do this:</p>

<pre><code>                  password
    alice     ------ OR -----&gt;  alice
(workstation)     ssh key      (server)
</code></pre>

<p>The <strong>important</strong> thing to note here is that she doesn't need ssh keys; she
can use passwords if she wants to.</p>

<p>Behind the scenes, the gitolite/git conversation is being transparently
forwarded to the gitolite hosting user, so it is <em>actually</em> like this:</p>

<pre><code>                  password                  ssh key
    alice     ------ OR -----&gt;  alice   - - - - - - - &gt;    git
(workstation)     ssh key      (server)    (REQUIRED)  (localhost)
</code></pre>

<p>The second connection is transparent to Alice; she still thinks she is talking
to her own userid.  In git URL terms, she simply uses <code>alice@server:reponame</code>,
without realising that behind the scenes this is getting forwarded to
<code>git@server:reponame</code>.</p>

<p>This second connection <em>does</em> require ssh keys, but since they're all on the
server, it's scriptable and automatable so the user doesn't have to deal with
these pesky ssh keys.</p>

<p><a name="_some_hints_notes_and_caveats"></a></p>

<h3>some hints, notes and caveats</h3>

<ul>
<li>This doesn't mean all your users have to be like this.  You can have
normal users also.  In fact, you can have users who give you a pub key
from their workstation the normal way, as well as use this method.</li>
</ul>

<p><a name="_what_the_2_scripts_actually_do"></a></p>

<h3>what the 2 scripts actually do</h3>

<ul>
<li><p><code>gl-shell</code> will become the new login shell for these users.  This shell
will forward git clone/fetch/push requests to the gitolite server.</p>

<p>This redirection is so transparent that I had to explicitly code a message
("forwarding to git@server") to make troubleshooting easier.</p></li>
<li><p><code>gl-shell-setup</code> is run by root, once for each user.  (You can run it
multiple times; it's designed to be idempotent).  As root, it changes the
user's shell to <code>gl-shell</code> (full path), then sets up an RSA key for the
user if one is not already present.  Then it runs as <code>git</code> (or whatever
the hosting user is) and takes the pubkey and adds it as (to continue our
example) <code>alice@localhost.pub</code> in keydir of the admin repo, which is then
pushed.</p>

<p>Notice the use of <a href="http://sitaramc.github.com/gitolite/doc/3-faq-tips-etc.html#_one_user_many_keys">this trick</a> to allow Alice to allow users to have
other (gitolite normal) keys as well, such as perhaps from a laptop.</p></li>
</ul>

<p><a name="_setting_it_up"></a></p>

<h3>setting it up</h3>

<p>Here's how to set this up.  First, the <strong>one-time</strong> tasks:</p>

<ul>
<li><p>Do this first, or you'll forget :-)  Add the host key for 'localhost' to
<code>/etc/ssh/ssh_known_hosts</code>.  And if it ever changes, update it.</p></li>
<li><p>Install gitolite as normal, if not already installed.  This will require
you to use ssh keys for your (admin's) own access, but I assume that's ok.</p></li>
<li><p>As root, copy the program <code>contrib/real-users/gl-shell</code> to
<code>/usr/local/bin</code>.</p></li>
<li><p>As root, customise the program <code>/usr/local/bin/gl-shell</code>.  You will need
to change some variables at the top in a section clearly marked
'site-local changes'.</p></li>
<li><p>As root, copy <code>contrib/real-users/gl-shell-setup</code> to some place on root's
<code>$PATH</code> and customise it similarly to gl-shell.  Note that there are many
more configurable values in this script.  <strong>NOTE</strong> also that this includes
fixing the <code>chsh</code> command, which may be OS/distro dependent.  The supplied
command is good for Fedora.</p></li>
</ul>

<p>Now, for each user 'alice' that has her own real (unix) userid, and also needs
to access gitolite <em>via</em> her own id, run the command <code>gl-shell-setup alice</code>.</p>

<p>And that's really all there is to it.</p>
